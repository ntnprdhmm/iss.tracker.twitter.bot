<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Follow the ISS</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="/public/style/main.css">
    </head>
    <body>

        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="#">
                        Follow the ISS
                    </a>
                </div>
            </div>
        </nav>

        <div class="row main-container">
            <div class="col-md-9 col-xs-12 left-side" id="map"></div>
            <div class="col-md-3 col-xs-12 right-side">Last tweets</div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script>
            let map;
            let marker;
            let previousCountryCode = null;

            /**
             * Create the map
             */
            function initMap() {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: -34.397, lng: 150.644},
                    zoom: 3
                });
                geocoder = new google.maps.Geocoder;
            }

            /**
             * Update the map target
             */
            function moveToLocation(lat, lng){
                const center = new google.maps.LatLng(lat, lng);
                map.panTo(center);
            }

            /**
             * Draw a new marker at the given coordinates
             * @param {string] lat: the latitude
             * @param {string] lng: the longitude
             */
            function drawMarker(lat, lng) {
                const position = {lat: parseFloat(lat), lng: parseFloat(lng)};

                // replace the last marker icon by a simple point
                if(marker) {
                    marker.setIcon({
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 2
                    });
                }

                const markerIcon = new google.maps.MarkerImage(
                    '/public/images/iss.png',
                    new google.maps.Size(64, 64),
                    new google.maps.Point(0, 0),
                    new google.maps.Point(32, 32)
                );

                // create a new point with the last ISS coordinates
                marker = new google.maps.Marker({
                    position,
                    map,
                    title: 'ISS !',
                    icon: markerIcon
                });
            }

            /**
             * Make a request to get the last coordinates of the ISS
             */
            function updateISSPosition() {
                $.ajax({
                    url: "http://api.open-notify.org/iss-now.json",
                    method: "get"
                }).done(function(data) {
                    const lat = data.iss_position.latitude;
                    const lng = data.iss_position.longitude;

                    // update the map
                    moveToLocation(lat, lng);
                    drawMarker(lat, lng);

                    // get the name of the city of the current location
                    // do nothing in the catch => it's simply because the location can't be found
                    getCountryCode(parseFloat(lat), parseFloat(lng))
                });
            }

            /**
             * Make a request to get the country code of a city from his coordinates
             * Geocoding doc : https://developers.google.com/maps/documentation/javascript/geocoding?hl=FR
             */
            function getCountryCode(lat, lng) {
                $.ajax({
                    url: `http://api.geonames.org/findNearbyPostalCodesJSON?lat=${lat}&lng=${lng}&username=demo`,
                    method: "get"
                }).done(function(data) {
                    if (data.postalCodes[0]) {
                        const countryCode = data.postalCodes[0].countryCode;
                        if (previousCountryCode != countryCode) {
                            previousCountryCode = countryCode;
                            getCountry(countryCode);
                        }
                    }
                });
            }

            /**
             * Make a request to get the language of a country from his country code
             */
            function getCountry(countryCode) {
                $.ajax({
                    url: `https://restcountries.eu/rest/v2/alpha/${countryCode.toLowerCase()}`,
                    method: "get"
                }).done(function(data) {
                    translateMessage(data.nativeName, data.languages[0][Object.keys(data.languages[0])[0]]);
                });
            }

            /**
             * Make a request to translate the default message into the country language
             */
            function translateMessage(countryName, languageCode) {
                const message = `The ISS is located above the ${countryName} !`;

                $.ajax({
                    url: `http://www.transltr.org/api/translate?text=${message}&to=${languageCode}&from=en`,
                    method: "get"
                }).done(function(data) {
                    console.log(data.translationText);
                });
            }

            function sendTweet(message) {
                console.log("tweet", message);
            }

            updateISSPosition();
            setInterval(_ => { updateISSPosition()}, 3500);
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCo2c7JUO_CKOregCnUwULdbVgVIdoGnOc&callback=initMap"></script>
        <script>
            // TESTS DATA
            const troyesLat = 48.2973451;
            const londonLat = 51.5073509;
            const parisLat = 48.856614;
            const troyesLng = 4.0744009000000005;
            const londonLng = -0.12775829999998223;
            const parisLng = 2.3522219000000177;

            /*getCountryCode(troyesLat, troyesLng);
            getCountryCode(londonLat, londonLng);
            getCountryCode(parisLat, parisLng);*/

        </script>
    </body>
</html>
